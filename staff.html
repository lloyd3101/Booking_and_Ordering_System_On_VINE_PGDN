<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Staff — Restobar</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --sidebar-bg:#ffffff; --sidebar-active:#ecfdf5;
    --text:#1e293b; --text-muted:#64748b;
    --accent:#10b981; --danger:#ef4444; --highlight:#059669;
    --card-bg:#ffffff; --card-hover:#f8fafc;
    --header-bg:#f8fafc;
  }
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Inter, Arial, sans-serif;}
  body{display:flex;height:100vh;background:#f8fafc;color:var(--text);}

  /* Sidebar */
  .sidebar{width:260px;background:var(--sidebar-bg);display:flex;flex-direction:column;justify-content:space-between;box-shadow: 2px 0 10px rgba(0,0,0,0.1);}
  .sidebar .brand{padding:24px 20px;display:flex;align-items:center;gap:12px;border-bottom: 1px solid rgba(0,0,0,0.1);}
  .sidebar .brand .logo{background:linear-gradient(135deg, #10b981, #059669);width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
  .sidebar .brand .text{font-weight:800;font-size:18px;line-height:1.2;background: linear-gradient(90deg, #059669, #10b981);-webkit-background-clip: text;-webkit-text-fill-color: transparent;}
  .sidebar nav{flex:1;display:flex;flex-direction:column;padding: 16px 12px;}
  .sidebar nav a{padding:14px 16px;color:var(--text-muted);text-decoration:none;font-weight:600;display:flex;align-items:center;gap: 12px;border-radius:8px;margin:4px 0;transition: all 0.3s ease;position: relative;}
  .sidebar nav a.active,.sidebar nav a:hover{background:var(--sidebar-active);color:var(--highlight);}
  .sidebar nav a.active:before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:4px;height:60%;background:var(--highlight);border-radius:0 4px 4px 0;}
  .sidebar .logout{margin:16px;padding:12px;text-align:center;background:rgba(239,68,68,0.1);color:var(--text);border:1px solid rgba(239,68,68,0.3);border-radius:8px;text-decoration:none;font-weight:600;cursor:pointer;transition: all 0.3s ease;display: flex;align-items: center;justify-content: center;gap: 8px;}
  .sidebar .logout:hover{background:rgba(239,68,68,0.2);}

  /* Main Content */
  .main{flex:1;overflow-y:auto;padding:32px; background:var(--header-bg);position:relative;}
  h2{margin-bottom:20px;color:var(--highlight);font-size:24px;font-weight:700;position: relative;padding-bottom: 8px;}
  h2:after{content:'';position:absolute;bottom:0;left:0;width:60px;height:3px;background:var(--highlight);border-radius: 2px;}
  .card{background:var(--card-bg);padding:20px;border-radius:12px;margin-bottom:20px;box-shadow: 0 4px 6px rgba(0,0,0,0.05);transition: all 0.3s ease;border: 1px solid rgba(0,0,0,0.05);}
  .card:hover{transform: translateY(-2px);box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);}
  .card h3{margin-bottom:8px;font-size:18px;font-weight:600;color:var(--text);}
  .muted{color:var(--text-muted);font-size:13px;}

  /* Stats Cards */
  .stats-container{display:grid;grid-template-columns:repeat(auto-fit, minmax(240px, 1fr));gap:20px;margin-bottom:32px;}
  .stat-card{background:var(--card-bg);padding:20px;border-radius:12px;box-shadow: 0 4px 6px rgba(0,0,0,0.05);border-left:4px solid var(--highlight);display:flex;flex-direction:column;transition: all 0.3s ease;}
  .stat-card:hover{transform: translateY(-3px);}
  .stat-card h3{font-size:14px;color:var(--text-muted);margin-bottom:8px;font-weight:500;}
  .stat-value{font-size:32px;font-weight:700;color:var(--highlight);}
  .stat-card:nth-child(2){border-left-color:var(--accent);}
  .stat-card:nth-child(3){border-left-color:#10b981;}

  /* Tables */
  table{width:100%;border-collapse:collapse;margin-top:12px;color:var(--text);border-radius: 8px;overflow: hidden;}
  th,td{padding:14px 16px;border-bottom:1px solid #e2e8f0;text-align:left;}
  th{background:#f1f5f9;font-weight:600;color:var(--highlight);}
  tr{transition: all 0.2s ease;}
  tr:hover{background: rgba(5, 150, 105, 0.03);}
  button{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition: all 0.2s ease;}
  .approve{background:var(--accent);color:#fff;margin-right:6px;}
  .approve:hover{background: #059669;transform: translateY(-1px);}
  .reject{background:var(--danger);color:#fff;}
  .reject:hover{background: #dc2626;transform: translateY(-1px);}

  /* Status colors */
  .status-Pending{color:#f59e0b; font-weight:600;}
  .status-Approved, .status-Confirmed{color:var(--accent); font-weight:600;}
  .status-Rejected{color:var(--danger); font-weight:600;}
  
  /* Profile Section */
  .profile{display:flex;align-items:center;margin-bottom:32px;padding:20px;background:var(--card-bg);border-radius:12px;box-shadow: 0 4px 6px rgba(0,0,0,0.05);border: 1px solid rgba(0,0,0,0.05);}
  .profile img{width:70px;height:70px;border-radius:50%;margin-right:20px;object-fit:cover;border: 3px solid var(--highlight);}
  .profile-info{display:flex;flex-direction:column;}
  .profile .name{font-weight:700;font-size:20px;color:var(--highlight);}
  .profile .role{color:var(--text-muted);font-size:14px;background: rgba(100,116,139,0.1);padding: 4px 10px;border-radius: 20px;width: fit-content;}
  
  /* Buffet info styles */
  .buffet-info {color: var(--highlight); font-weight: 600;}
  .no-buffet {color: var(--text-muted); font-style: italic;}

  /* Empty state */
  .empty-state{text-align:center;padding:40px 20px;color:var(--text-muted);}
  .empty-state-icon{font-size:48px;margin-bottom:16px;opacity: 0.5;}

  /* Responsive */
  @media (max-width: 768px) {
    body{flex-direction:column;}
    .sidebar{width:100%;height:auto;}
    .sidebar nav{flex-direction:row;justify-content: space-around;padding:10px;}
    .sidebar nav a{margin:0;padding:10px;font-size:14px;}
    .sidebar nav a.active:before{width:100%;height:3px;top:auto;bottom:0;border-radius: 3px 3px 0 0;}
    .main{padding:20px;}
    .stats-container{grid-template-columns:1fr;}
    table{font-size:14px;}
    th,td{padding:10px 12px;}
  }
</style>
</head>
<body>

<div class="sidebar">
  <div>
    <div class="brand">
      <div class="logo">RB</div>
      <div class="text">Restobar Staff</div>
    </div>
    <nav>
      <a href="#overview" class="active"><i class="fas fa-chart-pie"></i> Overview</a>
      <a href="#orders"><i class="fas fa-shopping-cart"></i> Orders</a>
      <a href="#reservations"><i class="fas fa-calendar-alt"></i> Reservations</a>
    </nav>
  </div>
  <a class="logout" href="auth.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
</div>

<div class="main">
  <!-- Profile Section -->
  <div class="profile">
    <img src="00740a4c-7e3f-4010-a159-ee0fa08f65ee.png" alt="Staff">
    <div class="profile-info">
      <span class="name">Staff User</span>
      <span class="role">Staff</span>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="stats-container">
    <div class="stat-card">
      <h3><i class="fas fa-shopping-cart"></i> Orders Pending</h3>
      <div class="stat-value" id="ordersCount">0</div>
    </div>
    <div class="stat-card">
      <h3><i class="fas fa-calendar-check"></i> Reservations Pending</h3>
      <div class="stat-value" id="reservationsCount">0</div>
    </div>
    <div class="stat-card">
      <h3><i class="fas fa-utensils"></i> Buffet Bookings Pending</h3>
      <div class="stat-value" id="buffetCount">0</div>
    </div>
  </div>

  <!-- Orders Table -->
  <h2 id="orders">Orders</h2>
  <div class="card">
    <table id="ordersTable">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Items</th>
          <th>Total</th>
          <th>Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Reservations Table -->
  <h2 id="reservations">Reservations</h2>
  <div class="card">
    <table id="reservationsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Contact</th>
          <th>Date</th>
          <th>Time</th>
          <th>Guests</th>
          <th>Event</th>
          <th>Buffet</th>
          <th>Price</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // ===== Helpers =====
  const safeText = (v) => (v === null || v === undefined || v === '') ? '-' : String(v);
  const normalizeStatusClass = (status) => 'status-' + (String(status || 'Pending').replace(/\s+/g, '-'));
  const formatCurrency = (num) => {
    const n = Number(num) || 0;
    // Use en-PH locale for ₱ symbol; fallback to manual if unavailable
    try {
      return n.toLocaleString('en-PH', { style: 'currency', currency: 'PHP', maximumFractionDigits: 2 });
    } catch (e) {
      return '₱' + n.toFixed(2);
    }
  };
  const parseNumber = (v) => {
    if (typeof v === 'number') return v;
    if (!v) return 0;
    // remove commas, currency symbols, spaces
    const cleaned = String(v).replace(/[^\d.\-]+/g, '');
    const parsed = parseFloat(cleaned);
    return isNaN(parsed) ? 0 : parsed;
  };

  // ===== Load data from localStorage =====
  let orders = JSON.parse(localStorage.getItem('restobar_orders') || '[]');
  let reservations = JSON.parse(localStorage.getItem('restobar_reservations') || '[]');

  // ===== Sales Tracking =====
  function addToSales(amount, type = 'order') {
    let salesData = JSON.parse(localStorage.getItem('restobar_sales') || '{"daily":[],"monthly":[]}');

    const today = new Date().toISOString().slice(0, 10);
    const currentMonth = new Date().toISOString().slice(0, 7);

    const amt = parseNumber(amount);

    let dailySale = salesData.daily.find(s => s.date === today);
    if (dailySale) dailySale.amount = (Number(dailySale.amount) || 0) + amt;
    else salesData.daily.push({ date: today, amount: amt });

    let monthlySale = salesData.monthly.find(s => s.month === currentMonth);
    if (monthlySale) monthlySale.amount = (Number(monthlySale.amount) || 0) + amt;
    else salesData.monthly.push({ month: currentMonth, amount: amt });

    localStorage.setItem('restobar_sales', JSON.stringify(salesData));
  }

  // ===== Safe date parsing with fallback =====
  function parseDateSafe(dateInput) {
    if (!dateInput) return null;
    const d = new Date(dateInput);
    if (!isNaN(d)) return d;
    // try ISO-ish parsing for timestamps or numbers
    const num = Number(dateInput);
    if (!isNaN(num)) {
      const d2 = new Date(num);
      if (!isNaN(d2)) return d2;
    }
    return null;
  }

  // ===== Render Orders (only show pending) =====
  function renderOrders(){
    const tbody = document.querySelector('#ordersTable tbody');
    tbody.innerHTML = '';

    // Show only pending orders (status === 'Pending' or undefined)
    const pendingOrders = orders.filter(o => {
      const st = (o && o.status) ? String(o.status).toLowerCase() : 'pending';
      return st === 'pending' || st === 'null' || st === '';
    });

    if (pendingOrders.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-shopping-cart"></i></div>
            <div>No orders found</div>
          </td>
        </tr>`;
    } else {
      // Sort by timestamp (newest first) with safe parsing
      const sortedOrders = [...pendingOrders].sort((a, b) => {
        const da = parseDateSafe(a.timestamp) || new Date(0);
        const db = parseDateSafe(b.timestamp) || new Date(0);
        return db - da;
      });

      sortedOrders.forEach((o)=>{
        const tr = document.createElement('tr');
        // build items list safely
        const itemsList = Array.isArray(o.items) && o.items.length
          ? o.items.map(item => `${safeText(item.name || item.item)} (${formatCurrency(parseNumber(item.price))})`).join(', ')
          : 'No items';

        const totalNum = parseNumber(o.total_amount || o.total);
        const displayTotal = formatCurrency(totalNum);

        const dateDisplay = parseDateSafe(o.timestamp || o.date_created || o.date) ? parseDateSafe(o.timestamp || o.date_created || o.date).toLocaleString() : (o.date || 'Unknown date');

        // status class normalized (no spaces)
        const statusClass = normalizeStatusClass(o.status);

        tr.innerHTML = `
          <td>#${safeText(o.id)}</td>
          <td>${safeText(o.customer_name || o.customer)}</td>
          <td>${itemsList}</td>
          <td>${displayTotal}</td>
          <td>${dateDisplay}</td>
          <td class="${statusClass}">${safeText(o.status || 'Pending')}</td>
          <td>
            <button class="approve" data-id="${safeText(o.id)}">Approve</button>
            <button class="reject" data-id="${safeText(o.id)}">Reject</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // Update pending orders count
    document.getElementById('ordersCount').textContent = pendingOrders.length;
  }

  // ===== Render Reservations (only show pending) =====
  function renderReservations(){
    const tbody = document.querySelector('#reservationsTable tbody');
    tbody.innerHTML = '';

    const pendingReservations = reservations.filter(r => {
      const st = (r && r.status) ? String(r.status).toLowerCase() : 'pending';
      return st === 'pending' || st === 'null' || st === '';
    });

    if (pendingReservations.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="11" class="empty-state">
            <div class="empty-state-icon"><i class="fas fa-calendar-times"></i></div>
            <div>No reservations found</div>
          </td>
        </tr>`;
    } else {
      // Sort by date (newest first) with safe parse
      const sortedReservations = [...pendingReservations].sort((a, b) => {
        const da = parseDateSafe(a.reservation_date || a.date) || new Date(0);
        const db = parseDateSafe(b.reservation_date || b.date) || new Date(0);
        return db - da;
      });

      sortedReservations.forEach((r)=>{
        const tr = document.createElement('tr');
        
        // Handle buffet package name - check multiple possible property names
        let buffetName = r.buffet_package_name || r.buffet_name || r.buffet;
        const buffetDisplay = buffetName && buffetName !== 'None' && buffetName !== 'null' 
          ? `<span class="buffet-info">${safeText(buffetName)}</span>` 
          : '<span class="no-buffet">No buffet</span>';
        
        const buffetPriceNum = parseNumber(r.buffet_price || r.buffetPrice);
        const buffetPrice = buffetPriceNum > 0 ? formatCurrency(buffetPriceNum) : '-';

        const timeRange = `${safeText(r.start_time || r.start)}${(r.start_time || r.start) && (r.end_time || r.end) ? ' - ' + safeText(r.end_time || r.end) : ((r.start_time || r.start) ? '' : safeText(r.end_time || r.end))}`;

        const statusClass = normalizeStatusClass(r.status);

        tr.innerHTML = `
          <td>#${safeText(r.id)}</td>
          <td>${safeText(r.customer_name || r.name)}</td>
          <td>${safeText(r.contact_number || r.contact)}</td>
          <td>${safeText(r.reservation_date || r.date)}</td>
          <td>${timeRange}</td>
          <td>${safeText(r.guests || '0')}</td>
          <td>${safeText(r.event_type || r.event)}</td>
          <td>${buffetDisplay}</td>
          <td>${buffetPrice}</td>
          <td class="${statusClass}">${safeText(r.status || 'Pending')}</td>
          <td>
            <button class="approve" data-id="${safeText(r.id)}" data-type="res">Approve</button>
            <button class="reject" data-id="${safeText(r.id)}" data-type="res">Reject</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // Update counts
    document.getElementById('reservationsCount').textContent = pendingReservations.length;
    const buffetBookings = pendingReservations.filter(r => {
      const buffetName = r.buffet_package_name || r.buffet_name || r.buffet;
      return buffetName && buffetName !== 'None' && buffetName !== 'null';
    });
    document.getElementById('buffetCount').textContent = buffetBookings.length;
  }

  // ===== Order / Reservation Actions (delegated) =====
  document.addEventListener('click', function(e) {
    const el = e.target;
    if (el.matches('button.approve')) {
      const id = el.dataset.id;
      const isRes = el.dataset.type === 'res';
      if (isRes) {
        approveRes(id);
      } else {
        approveOrder(id);
      }
    } else if (el.matches('button.reject')) {
      const id = el.dataset.id;
      const isRes = el.dataset.type === 'res';
      if (isRes) {
        rejectRes(id);
      } else {
        rejectOrder(id);
      }
    }
  });

  // ===== Order Actions =====
  // ===== Order Actions with AJAX =====
function approveOrder(orderId){
    if(!confirm("Approve this order?")) return;
    
    fetch('approve_handler.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=approve&id=${orderId}&type=order`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update localStorage to match database
            const orderIndex = orders.findIndex(o => String(o.id) == String(orderId));
            if (orderIndex !== -1) {
                orders[orderIndex].status = 'Confirmed';
                localStorage.setItem('restobar_orders', JSON.stringify(orders));
            }
            renderOrders();
            alert(data.message);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error occurred');
    });
}

function rejectOrder(orderId){
    if(!confirm("Reject this order?")) return;
    
    fetch('approve_handler.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=reject&id=${orderId}&type=order`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update localStorage to match database
            const orderIndex = orders.findIndex(o => String(o.id) == String(orderId));
            if (orderIndex !== -1) {
                orders[orderIndex].status = 'Rejected';
                localStorage.setItem('restobar_orders', JSON.stringify(orders));
            }
            renderOrders();
            alert(data.message);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error occurred');
    });
}

// ===== Reservation Actions with AJAX =====
function approveRes(reservationId){
    if(!confirm("Approve this reservation?")) return;
    
    fetch('approve_handler.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=approve&id=${reservationId}&type=reservation`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update localStorage to match database
            const resIndex = reservations.findIndex(r => String(r.id) == String(reservationId));
            if (resIndex !== -1) {
                reservations[resIndex].status = 'Confirmed';
                localStorage.setItem('restobar_reservations', JSON.stringify(reservations));
            }
            renderReservations();
            alert(data.message);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error occurred');
    });
}

function rejectRes(reservationId){
    if(!confirm("Reject this reservation?")) return;
    
    fetch('approve_handler.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `action=reject&id=${reservationId}&type=reservation`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update localStorage to match database
            const resIndex = reservations.findIndex(r => String(r.id) == String(reservationId));
            if (resIndex !== -1) {
                reservations[resIndex].status = 'Rejected';
                localStorage.setItem('restobar_reservations', JSON.stringify(reservations));
            }
            renderReservations();
            alert(data.message);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error occurred');
    });
}

  // ===== Reservation Actions =====
  function approveRes(reservationId){
    if(!confirm("Approve this reservation?")) return;
    const resIndex = reservations.findIndex(r => String(r.id) == String(reservationId));
    if (resIndex !== -1) {
      reservations[resIndex].status = 'Confirmed';
      const reservation = reservations[resIndex];
      
      // Track sales for buffet bookings
      if ((reservation.buffet_package_name || reservation.buffet_name || reservation.buffet) && 
          reservation.buffet_package_name !== 'None' && 
          reservation.buffet_package_name !== 'null') {
        const buffetPrice = parseNumber(reservation.buffet_price || reservation.buffetPrice) || 0;
        if (buffetPrice > 0) addToSales(buffetPrice, 'reservation');
      }
      
      localStorage.setItem('restobar_reservations', JSON.stringify(reservations));
      renderReservations();
      alert('Reservation approved successfully!');
    } else {
      alert('Reservation not found!');
    }
  }

  function rejectRes(reservationId){
    if(!confirm("Reject this reservation?")) return;
    const resIndex = reservations.findIndex(r => String(r.id) == String(reservationId));
    if (resIndex !== -1) {
      reservations[resIndex].status = 'Rejected';
      localStorage.setItem('restobar_reservations', JSON.stringify(reservations));
      renderReservations();
      alert('Reservation rejected!');
    } else {
      alert('Reservation not found!');
    }
  }

  // ===== Data Refresh Function =====
  function refreshData() {
    orders = JSON.parse(localStorage.getItem('restobar_orders') || '[]');
    reservations = JSON.parse(localStorage.getItem('restobar_reservations') || '[]');
    renderOrders();
    renderReservations();
  }

  // ===== Initial Render =====
  refreshData();

  // Add active class to sidebar items on click
  document.querySelectorAll('.sidebar nav a').forEach(item => {
    item.addEventListener('click', function() {
      document.querySelectorAll('.sidebar nav a').forEach(i => i.classList.remove('active'));
      this.classList.add('active');
    });
  });

  // Auto-refresh data every 5 seconds to catch new reservations/orders
  setInterval(refreshData, 5000);

  // For debugging: expose reload functions in console
  window._restobar_reload = refreshData;
</script>
</body>
</html>